<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docx Converter Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 20px; background: #eef2f3; text-align: center; }
        .box { background: white; max-width: 500px; margin: 20px auto; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Status Indicators */
        .status-dot { height: 12px; width: 12px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .ready { background-color: #28a745; } /* Green */
        .error { background-color: #dc3545; } /* Red */

        /* File Input Styling */
        input[type="file"] { display: none; }
        .custom-upload { 
            display: block; padding: 15px; border: 2px dashed #007bff; color: #007bff; 
            border-radius: 10px; cursor: pointer; margin-bottom: 20px; font-weight: bold;
        }
        .custom-upload:hover { background: #f0f8ff; }

        button { 
            background: #28a745; color: white; border: none; padding: 15px 30px; 
            font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }

        #logArea { 
            margin-top: 20px; text-align: left; background: #222; color: #0f0; 
            padding: 15px; font-family: monospace; font-size: 12px; 
            border-radius: 8px; min-height: 100px; max-height: 200px; overflow-y: auto; 
        }
    </style>
</head>
<body>

    <div class="box">
        <h2>ShreeLipi to Unicode</h2>
        
        <div style="margin-bottom: 15px; font-size: 14px;">
            <span id="libStatusDot" class="status-dot"></span> 
            <span id="libStatusText">Checking System...</span>
        </div>

        <label for="fileInput" class="custom-upload">
            üìÑ Tap here to Select .docx File
        </label>
        <input type="file" id="fileInput" accept=".docx">
        
        <div id="fileName" style="margin-bottom: 15px; color: #555;">No file selected</div>

        <button id="convertBtn" disabled>Convert Now</button>
        
        <div id="logArea">Waiting for action...</div>
    </div>

    <script>
        // --- 1. SETUP & UTILS ---
        const logBox = document.getElementById('logArea');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const convertBtn = document.getElementById('convertBtn');
        const libDot = document.getElementById('libStatusDot');
        const libText = document.getElementById('libStatusText');

        function log(msg, isError = false) {
            const color = isError ? '#ff4444' : '#00ff00';
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }

        // --- 2. INITIALIZATION CHECK ---
        window.onload = function() {
            if (typeof JSZip !== 'undefined') {
                libDot.classList.add('ready');
                libText.innerText = "System Ready (JSZip Loaded)";
                log("System Initialized.");
            } else {
                libDot.classList.add('error');
                libText.innerText = "Error: Internet Required!";
                log("Error: JSZip library failed to load.", true);
                alert("Please connect to Internet to load the converter library.");
            }
        };

        // --- 3. EVENT LISTENERS ---
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileNameDisplay.innerText = "Selected: " + this.files[0].name;
                convertBtn.disabled = false;
                convertBtn.style.opacity = "1";
                log("File selected: " + this.files[0].name);
            } else {
                fileNameDisplay.innerText = "No file selected";
                convertBtn.disabled = true;
            }
        });

        convertBtn.addEventListener('click', processDocx);

        // --- 4. CONVERSION LOGIC (Pure Function) ---
        // (‡§§‡•Å‡§Æ‡§ö‡•á ‡§ú‡•Å‡§®‡•á ‡§≤‡•â‡§ú‡§ø‡§ï ‡§á‡§•‡•á ‡§∂‡•â‡§∞‡•ç‡§ü ‡§ï‡•á‡§≤‡•á ‡§Ü‡§π‡•á, ‡§™‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§≤)
        const shree = ['u','¬™','}','n','p','H','¬∑','I','¬ª','J','¬Ω','K','M','√Ä','N','¬µO','O','¬µ√Å','√Å','P','Q','R','¬∂S','S','¬∂T','T','U','√ä','W','√è','V','√ã','Y','√ú','X','Z','√ù','\\','√¢','[','√ü','^','√§',']','√£','_','√•','`','a','c','√´','d','√¨','e','√ª','√≠','f','√Æ','g','√±','h','j','√∫','k','√î','√õ','√ö','√†','√û','Q¬≠','¬∫$','√å','√ê','√ï','l','√ém','¬∏','‚Äû','ÀÜ','≈ì','√Ö','Am¬°','Am{','Am|','Am','A','B¬©','B','C','D','E{','E','F','m¬∞','m{','m|','{','|','m¬°','m¬¢','¬°','¬¢','m','r','s','t','w','√æ','y','¬ß','¬±','‚Ä¢','¬•','¬≤','√ë','¬´','√©','√™','&','$','>','¬µ'];
        const uni = ['¬©','¬©‡§Ç','{¬©','o','o',"‡§ï",'‡§ï‡•ç‚Äå',"‡§ñ",'‡§ñ‡•ç‚Äå',"‡§ó",'‡§ó‡•ç',"‡§ò",'‡§ö','‡§ö‡•ç‚Äå','‡§õ','‡§ú‡§º','‡§ú','‡§ú‡§º‡•ç‚Äå','‡§ú‡•ç‚Äå','‡§ù',"‡§ü","‡§†",'‡§°‡§º',"‡§°",'‡§¢‡§º','‡§¢',"‡§£",'‡§£‡•ç',"‡§•",'‡§•‡•ç',"‡§§",'‡§§‡•ç',"‡§ß",'‡§ß‡•ç',"‡§¶","‡§®",'‡§®‡•ç',"‡§´",'‡§´‡•ç‚Äå',"‡§™",'‡§™‡•ç‚Äå',"‡§≠",'‡§≠‡•ç',"‡§¨",'‡§¨‡•ç‚Äå',"‡§Æ",'‡§Æ‡•ç',"‡§Ø","‡§∞","‡§≤",'‡§≤‡•ç‚Äå',"‡§µ",'‡§µ‡•ç‚Äå',"‡§∂",'‡§∂‡•ç','‡§∂‡•ç',"‡§∑",'‡§∑‡•ç‚Äå',"‡§∏",'‡§∏‡•ç',"‡§π",'‡§ï‡•ç‡§∑','‡§ï‡•ç‡§∑‡•ç','‡§ú‡•ç‡§û','‡§¶‡•ç‡§¶','‡§¶‡•ç‡§µ','‡§¶‡•ç‡§Ø','‡§™‡•ç‡§∞','‡§®‡•ç‡§®','‡§ü‡•ç‡§∞','‡§ï‡•ç‡§§','‡§§‡•ç‡§∞','‡§¶‡•ç‡§∞','‡§¶‡•ç‡§ß','‡§∂‡•ç‡§∞','‡§§‡•ç‡§§','‡§ï‡•ç‡§ï','‡§≤‡•ç‡§≤','‡§π‡•ç‡§µ','‡§∂‡•ç‡§µ','‡§ü‡•ç‡§ü','‡§î','‡§ì','‡§ì‡§Ç','‡§Ü','‡§Ö','‡§à','‡§á','‡§â','‡§ä','‡§ê','‡§è','‡§ã','‡•â',"‡•ã","‡•ã‡§Ç","‡•á","‡•á‡§Ç","‡•å","‡•å‡§Ç","‡•à",'‡•à‡§Ç',"‡§æ","‡•Ä","‡•Ä","‡•Ä‡§Ç","‡•Å",'‡•Å',"‡•Ç",'‡§Ç','‡§Å','‡§É','‡•É','‡•ç‚Äå','‡§¶‡•É','‡•ç‡§∞','‡§∞‡•Å','‡§∞‡•Ç','‡•§','','',''];

        function convertString(txt) {
            if (!txt) return "";
            let res = txt;
            // Basic Swap
            for(let i=0; i<shree.length; i++) {
                if(shree[i] && uni[i]) res = res.split(shree[i]).join(uni[i]);
            }
            // Fixes
            // 'i' Matra (o -> ‡§ø) - Simple Loop
            while(res.includes("o")) {
                let idx = res.indexOf("o");
                if(idx < res.length-1) {
                    let next = res.charAt(idx+1);
                    res = res.substring(0, idx) + next + "‡§ø" + res.substring(idx+2);
                } else {
                    res = res.replace("o", "‡§ø‡§Ç"); // End case
                }
            }
            res = res.replace(/o/g, "‡§ø‡§Ç"); // Cleanup
            
            // Reph (Rafar)
            const matras = "‡§æ‡§ø‡•Ä‡•Å‡•Ç‡•É‡•á‡•à‡•ã‡•å‡§Ç‡§É‡§Å‡•Ö";
            let rIdx = res.indexOf("¬©");
            while(rIdx > 0) {
                let p = rIdx - 1;
                while(p >= 0 && matras.includes(res.charAt(p))) p--;
                if(p < 0) p = 0;
                
                let chunk = res.substring(p, rIdx);
                res = res.substring(0, p) + "‡§∞‡•ç" + chunk + res.substring(rIdx+1);
                rIdx = res.indexOf("¬©", p + chunk.length + 2); // Search next
            }
            return res;
        }

        // --- 5. MAIN PROCESS ---
        async function processDocx() {
            if (!fileInput.files.length) return;
            
            const file = fileInput.files[0];
            log("Reading file: " + file.name);
            convertBtn.disabled = true;
            convertBtn.innerText = "Processing...";

            try {
                const data = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(data);
                
                // Validate Docx
                if (!zip.file("word/document.xml")) {
                    throw new Error("Invalid .docx file! (word/document.xml missing)");
                }
                log("File structure OK.");

                const docXml = await zip.file("word/document.xml").async("string");
                
                // Parse XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, "text/xml");
                const textNodes = xmlDoc.getElementsByTagName("w:t");
                
                log(`Found ${textNodes.length} text fragments.`);
                
                // Convert
                let count = 0;
                for (let i = 0; i < textNodes.length; i++) {
                    let original = textNodes[i].textContent;
                    if(original && original.trim().length > 0) {
                        textNodes[i].textContent = convertString(original);
                        count++;
                    }
                }
                log(`Converted ${count} fragments.`);

                // Re-pack
                const serializer = new XMLSerializer();
                const newXml = serializer.serializeToString(xmlDoc);
                zip.file("word/document.xml", newXml);
                
                const blob = await zip.generateAsync({type:"blob"});
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Converted_" + file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                log("Download started!");
                convertBtn.innerText = "Done! Convert Another";
                
            } catch (err) {
                log("Error: " + err.message, true);
                alert("Failed: " + err.message);
                convertBtn.innerText = "Try Again";
            } finally {
                convertBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
