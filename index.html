<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShreeLipi Pro V2 (Perfect 2-way)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; background: #eef1f5; text-align: center; padding: 20px; }
        .card { background: white; max-width: 700px; margin: 25px auto; padding: 35px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { color: #2d3436; margin-bottom: 5px; }
        p { color: #636e72; font-size: 14px; margin-bottom: 25px; }
        
        .mode-selector {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 25px;
            background: #f1f2f6; padding: 8px; border-radius: 12px;
        }
        .radio-label {
            padding: 12px 24px; cursor: pointer; border-radius: 8px; font-weight: 600; color: #555; transition: 0.2s;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            background: #0984e3; color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
        }

        .upload-area {
            border: 2px dashed #0984e3; background: #f0f8ff; color: #0984e3;
            padding: 40px; border-radius: 14px; font-weight: 600; cursor: pointer;
            display: block; margin-bottom: 20px;
        }
        textarea {
            width: 100%; height: 100px; padding: 15px; border: 1px solid #dfe6e9; border-radius: 12px;
            font-size: 16px; margin-bottom: 20px; font-family: 'Arial Unicode MS', sans-serif;
        }
        button {
            background: #00b894; color: white; border: none; padding: 18px; width: 100%;
            border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
        }
        button:disabled { background: #b2bec3; cursor: not-allowed; }
        #status { margin-top: 20px; font-size: 15px; font-weight: 500; }
    </style>
</head>
<body>

    <div class="card">
        <h2>ShreeLipi Pro V2 (2-in-1)</h2>
        <p>Advanced Unicode ‚ü∑ ShreeLipi Converter</p>

        <div class="mode-selector">
            <input type="radio" id="modeSL" name="mode" value="sl2uni" checked>
            <label for="modeSL" class="radio-label">ShreeLipi ‚ûù Unicode</label>

            <input type="radio" id="modeUni" name="mode" value="uni2sl">
            <label for="modeUni" class="radio-label">Unicode ‚ûù ShreeLipi</label>
        </div>

        <textarea id="inputText" placeholder="Paste text here to test..."></textarea>

        <label for="fileInput" class="upload-area">
            üìÇ Tap to Select Word File (.docx)
        </label>
        <input type="file" id="fileInput" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
        
        <div id="fileName" style="margin-bottom: 15px; color: #555;"></div>
        <button id="convertBtn">Convert Now</button>
        <div id="status"></div>
    </div>

    <script>
        // --- DATASETS (V21 Basis) ---
        const shreelipi_list = ['‚Ä¶','b','√ø','√Ñ','@','Q¬¥','u','¬™','}','[','p','H','¬≥','I','¬ª','J','¬Ω','K','M','√Ä','N','¬µO','O','¬µ√Å','√Å','P','Q','R','¬∂S','S','¬∂T','T','U','√ä','W','√è','V','√ã','Y','√ú','X','Z','√ù','‚Äô','√¢','n','√ü','^','√§','~','√£','‚Äò','√•','¬∂','a','c','√´','d','√¨','e','√ª','√≠','f','√Æ','g','√±','h','j','√∫','k','√î','√õ','√ö','√†','√û','Q¬≠','¬∫$','√å','√ê','√ï','l','√ém','¬∏','‚Äû','ÀÜ','≈ì','√Ö','Am¬°','Amo','Am|','Am','A','B¬©','B','C','D','Eo','E','F','m¬∞','mo','m|','o','|','m¬°','m¬¢','¬°','¬¢','m','r','s','t','w','√æ','y','¬ß','¬±','‚Ä¢','¬•','¬≤','√ë','¬´','√©','√™','&','$','>','¬µ', 'G', 'L', 'v', 'x', '%', '=', '(', ')', '√∑', '¬£', '¬æ', '¬®', '√Ü', '√á', '√é', '√è', '√º', '√∂', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        
        const unicode_list = ['‡§É',"‡§≤","‡•Ç","‡§û‡•ç",'‡§Ω','‡§ü‡•ç‡§∞','¬©','¬©‡§Ç','{¬©','{','{',"‡§ï",'‡§ï‡•ç',"‡§ñ",'‡§ñ‡•ç',"‡§ó",'‡§ó‡•ç',"‡§ò",'‡§ö','‡§ö‡•ç','‡§õ','‡§ú‡§º','‡§ú','‡§ú‡§º‡•ç','‡§ú‡•ç','‡§ù',"‡§ü","‡§†",'‡§°‡§º',"‡§°",'‡§¢‡§º','‡§¢',"‡§£",'‡§£‡•ç',"‡§•",'‡§•‡•ç',"‡§§",'‡§§‡•ç',"‡§ß",'‡§ß‡•ç',"‡§¶","‡§®",'‡§®‡•ç',"‡§´",'‡§´‡•ç',"‡§™",'‡§™‡•ç',"‡§≠",'‡§≠‡•ç',"‡§¨",'‡§¨‡•ç',"‡§Æ",'‡§Æ‡•ç',"‡§Ø","‡§∞","‡§≤",'‡§≤‡•ç',"‡§µ",'‡§µ‡•ç',"‡§∂",'‡§∂‡•ç','‡§∂‡•ç',"‡§∑",'‡§∑‡•ç',"‡§∏",'‡§∏‡•ç',"‡§π",'‡§ï‡•ç‡§∑','‡§ï‡•ç‡§∑‡•ç','‡§ú‡•ç‡§û','‡§¶‡•ç‡§¶','‡§¶‡•ç‡§µ','‡§¶‡•ç‡§Ø','‡§™‡•ç‡§∞','‡§®‡•ç‡§®','‡§ü‡•ç‡§∞','‡§ï‡•ç‡§§','‡§§‡•ç‡§∞','‡§¶‡•ç‡§∞','‡§¶‡•ç‡§ß','‡§∂‡•ç‡§∞','‡§§‡•ç‡§§','‡§ï‡•ç‡§ï','‡§≤‡•ç‡§≤','‡§π‡•ç‡§µ','‡§∂‡•ç‡§µ','‡§ü‡•ç‡§ü','‡§î','‡§ì','‡§ì‡§Ç','‡§Ü','‡§Ö','‡§à','‡§á','‡§â','‡§ä','‡§ê','‡§è','‡§ã','‡•â',"‡•ã","‡•ã‡§Ç","‡•á","‡•á‡§Ç","‡•å","‡•å‡§Ç","‡•à",'‡•à‡§Ç',"‡§æ","‡•Ä","‡•Ä","‡•Ä‡§Ç","‡•Å",'‡•Å',"‡•Ç",'‡§Ç','‡§Å','‡§É','‡•É','‡•ç','‡§¶‡•É','‡•ç‡§∞','‡§∞‡•Å','‡§∞‡•Ç','‡•§','‡•§','','', '‡§ú', '‡§ß', '‡•à', '‡•Ö', '‡•Ñ', '.', '(', ')', '‡§π‡•ç‡§Æ', '‡•Ä', '‡§ó‡•ç‡§®', '‡•ç‡§Ø', '‡§∞‡•ç‚Äç', '‡§∑‡•ç‡§ü', '‡§§‡•ç‡§§', '‡§ï‡•ç‡§§', '‡§∂‡•ç‡§ö', '‡§Ç', '‡•¶', '‡•ß', '‡•®', '‡•©', '‡•™', '‡•´', '‡•¨', '‡•≠', '‡•Æ', '‡•Ø'];

        // Dictionary for SL -> Uni
        const dictionary = [
            { wrong: '‡§∏‡§ï‡§≥‡§≥‡•Ä', right: '‡§∏‡§ï‡§≥‡•Ä' }, { wrong: '‡§∞‡§§‡•ç‡§®‡§æ‡§ï‡§≥‡§∞', right: '‡§∞‡§§‡•ç‡§®‡§æ‡§ï‡§∞' },
            { wrong: '‡§Æ‡§π‡•ç‡§£‡•å‡§≥‡§®‡§ø', right: '‡§Æ‡•ç‡§π‡§£‡•å‡§®‡§ø' }, { wrong: '‡§®‡§ø‡§∂‡•ç‡§ö‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ï‡§≥', right: '‡§®‡§ø‡§∂‡•ç‡§ö‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ï' },
            { wrong: '‡§ü‡•Ä‚óå‡§ï‡§≥‡§æ', right: '‡§ü‡•Ä‡§ï‡§æ' }, { wrong: '‡§ü‡•Ä‡§ï‡§æ‡§ï‡§≥‡§æ‡§∞‡•Ä', right: '‡§ü‡•Ä‡§ï‡§æ‡§ï‡§æ‡§∞‡•Ä' },
            { wrong: '‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï‡§≥', right: '‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï' }
        ];

        // Prepare Reverse Map (Uni -> SL)
        // Ensure critical missing characters are mapped manually
        let reverseMap = [];
        // Add specific overrides first
        reverseMap.push({ u: '‡•É', s: '‚Ä¢' }); // Rukara
        reverseMap.push({ u: '‡§ø', s: '{' }); // Velanti (Placeholder)
        reverseMap.push({ u: '‡§Ç', s: '√∂' }); // Anuswar
        reverseMap.push({ u: '‡§§‡•ç‡§∞', s: '¬∫$' }); // Tra
        reverseMap.push({ u: '‡§™‡•ç‡§∞', s: '√ö' }); // Pra
        reverseMap.push({ u: '‡§¶‡•ç‡§Ø', s: '√õ' }); // Dya
        reverseMap.push({ u: '‡§∂‡•ç‡§ö', s: '√º' }); // Sch
        
        // Add standard list
        for(let i=0; i<unicode_list.length; i++) {
            if(unicode_list[i] && shreelipi_list[i]) {
                reverseMap.push({ u: unicode_list[i], s: shreelipi_list[i] });
            }
        }
        reverseMap.sort((a, b) => b.u.length - a.u.length);

        // --- CONVERSION: SL -> Unicode ---
        function convertSLtoUni(text) {
            let res = text;
            res = res.replace(/\{i>/g, "‡§∑‡•ç‡§ü‡§ø"); res = res.replace(/\{√é/g, "‡§§‡•ç‡§§‡§ø"); res = res.replace(/\{√è/g, "‡§ï‡•ç‡§§‡§ø");
            res = res.split('√º').join('‡§∂‡•ç‡§ö'); res = res.split('√∑').join('‡§π‡•ç‡§Æ'); res = res.split('√∂').join('‡§Ç');
            res = res.split('√î').join('‡§Ø'); res = res.split('√á').join('‡§ó'); res = res.replace(/¬∫(?!\$)/g, '‡§§');
            res = res.split('|').join('‡§æ'); res = res.split('¬¶').join('‡§æ'); res = res.split('$').join('‡§≥');
            res = res.split('¬£').join('‡•Ä'); res = res.split('i').join('‡•Ä'); res = res.split('¬®').join(''); 
            
            // Velanti Swap
            let pos_curly = res.indexOf("{");
            while (pos_curly !== -1) {
                if (pos_curly + 1 < res.length) {
                    let next = res.charAt(pos_curly + 1);
                    if (next !== ' ' && next !== '¬©') res = res.replace("{" + next, next + "‡§ø");
                }
                pos_curly = res.indexOf("{", pos_curly + 1);
            }
            let pos_grt = res.indexOf(">");
            while (pos_grt !== -1) {
                if (pos_grt + 1 < res.length) {
                    let next = res.charAt(pos_grt + 1);
                    if (next !== ' ' && next !== '¬©') res = res.replace(">" + next, next + "‡§ø");
                }
                pos_grt = res.indexOf(">", pos_grt + 1);
            }

            // Main Map
            for (let i = 0; i < shreelipi_list.length; i++) {
                if (shreelipi_list[i] && unicode_list[i]) res = res.split(shreelipi_list[i]).join(unicode_list[i]);
            }

            // Post Fixes
            res = res.replace(/o/g, "‡§ø‡§Ç"); // Matra fix
            res = res.split('‡§≠‡§æ¬©').join('‡§∞‡•ç‡§≠‡§æ');
            res = res.split('‡§µ‡§æ¬©').join('‡§∞‡•ç‡§µ‡§æ');

            // Rafar Logic
            const matras = "‡§æ‡§ø‡•Ä‡•Å‡•Ç‡•É‡•á‡•à‡•ã‡•å‡§Ç‡§É‡§Å‡•Ö";
            let pos_reph = res.indexOf("¬©");
            while (pos_reph > 0) {
                let prob = pos_reph - 1;
                while (prob >= 0 && matras.includes(res.charAt(prob))) prob--;
                if (prob < 0) prob = 0;
                let chunk = res.substring(prob, pos_reph);
                res = res.substring(0, prob) + "‡§∞‡•ç" + chunk + res.substring(pos_reph + 1);
                pos_reph = res.indexOf("¬©");
            }

            // Dictionary Clean
            res = res.replace(/‚óå/g, ''); 
            dictionary.forEach(item => { res = res.replace(new RegExp(item.wrong, 'g'), item.right); });
            res = res.replace(/‡§≥‡§≥/g, '‡§≥'); res = res.replace(/‡§≥‡§≥‡•Ä/g, '‡§≥‡•Ä');

            return res;
        }

        // --- CONVERSION: Unicode -> SL (Improved) ---
        function convertUnitoSL(text) {
            let res = text;
            
            // 1. Reph Logic (Move '‡§∞‡•ç' to end of cluster)
            // Finds '‡§∞‡•ç' followed by a Consonant Cluster (Consonant + Halant + Consonant...)
            // Matches: \u0930\u094d (Reph) followed by ONE or MORE Consonants/Halants
            res = res.replace(/\u0930\u094d((?:[\u0915-\u0939]\u094d)*[\u0915-\u0939])/g, "$1\u00a9");

            // 2. Velanti Logic (Swap Position)
            // Finds (Consonant Cluster) + '‡§ø'
            // Moves '‡§ø' to START of cluster and changes to '{'
            res = res.replace(/((?:[\u0915-\u0939]\u094d)*[\u0915-\u0939])\u093f/g, "{$1");

            // 3. Main Mapping
            for (let i = 0; i < reverseMap.length; i++) {
                if (res.includes(reverseMap[i].u)) {
                    res = res.split(reverseMap[i].u).join(reverseMap[i].s);
                }
            }

            // 4. Force Kana
            res = res.split('‡§æ').join('|');

            return res;
        }

        // --- HANDLERS ---
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const fileNameDiv = document.getElementById('fileName');
        const statusDiv = document.getElementById('status');
        const inputTextArea = document.getElementById('inputText');
        const radios = document.getElementsByName('mode');

        fileInput.addEventListener('change', () => {
            if(fileInput.files.length > 0) fileNameDiv.innerText = "Selected: " + fileInput.files[0].name;
        });

        convertBtn.addEventListener('click', async () => {
            const mode = Array.from(radios).find(r => r.checked).value;
            const textVal = inputTextArea.value;

            // Text Mode
            if(textVal) {
                inputTextArea.value = (mode === 'sl2uni') ? convertSLtoUni(textVal) : convertUnitoSL(textVal);
                statusDiv.innerText = "Text Converted!";
                statusDiv.style.color = "#00b894";
                return;
            }

            // File Mode
            if(fileInput.files.length === 0) { alert("Select file first."); return; }
            convertBtn.disabled = true; convertBtn.innerText = "Processing...";
            
            try {
                if (typeof JSZip === 'undefined') throw new Error("Internet Needed.");
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const docXml = await zip.file("word/document.xml").async("string");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, "text/xml");
                const textNodes = xmlDoc.getElementsByTagName("w:t");

                for (let i = 0; i < textNodes.length; i++) {
                    let original = textNodes[i].textContent;
                    if (original && original.trim().length > 0) {
                        textNodes[i].textContent = (mode === 'sl2uni') ? convertSLtoUni(original) : convertUnitoSL(original);
                    }
                }

                const serializer = new XMLSerializer();
                const newDocXml = serializer.serializeToString(xmlDoc);
                zip.file("word/document.xml", newDocXml);
                const blob = await zip.generateAsync({type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                let prefix = (mode === 'sl2uni') ? "Unicode_" : "ShreeLipi_";
                a.download = prefix + file.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                
                convertBtn.innerText = "Done!";
                statusDiv.innerText = "Success!";
                statusDiv.style.color = "green";
                setTimeout(() => { convertBtn.disabled = false; convertBtn.innerText = "Convert Now"; }, 2000);

            } catch (err) {
                alert("Error: " + err.message);
                convertBtn.innerText = "Try Again";
                convertBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
