<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShreeLipi Stable V6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: -apple-system, sans-serif; background: #f8f9fa; text-align: center; padding: 20px; }
        .card { background: white; max-width: 650px; margin: 30px auto; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: #333; margin-bottom: 5px; }
        p { color: #666; font-size: 14px; margin-bottom: 25px; }
        
        .upload-area {
            border: 2px dashed #007aff; background: #eef7ff; color: #007aff;
            padding: 30px; border-radius: 12px; font-weight: 600; cursor: pointer;
            display: block; margin-bottom: 20px; transition: 0.3s;
        }
        .upload-area:hover { background: #e0efff; }
        input[type="file"] { display: none; }

        button {
            background: #28a745; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        #status { margin-top: 15px; font-size: 14px; color: #333; font-weight: 500; }
        #fileName { margin-bottom: 15px; color: #555; }

        /* Report Box */
        #reportBox {
            margin-top: 25px; text-align: left; background: #fff3cd; 
            border: 1px solid #ffeeba; border-radius: 10px; padding: 15px; display: none;
        }
        #wordList { 
            font-family: monospace; font-size: 13px; color: #856404; 
            max-height: 150px; overflow-y: auto; background: white; 
            padding: 10px; border: 1px solid #eee; border-radius: 6px;
        }
    </style>
</head>
<body>

    <div class="card">
        <h2>Word to Word (Stable V6)</h2>
        <p>Restored Working Logic + Added Report Feature.</p>

        <label for="fileInput" class="upload-area">
            üìÇ Select Word File (.docx)
        </label>
        <input type="file" id="fileInput" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
        
        <div id="fileName"></div>
        <button id="convertBtn" disabled>Convert Now</button>
        <div id="status"></div>

        <div id="reportBox">
            <div style="color: #856404; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Check these words (Unconverted):</div>
            <div id="wordList"></div>
        </div>
    </div>

    <script>
        // --- 1. MAPPING DATA (Standard + New Fixes) ---
        // V4 ‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä + ‡§§‡•Å‡§Æ‡§ö‡•á ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü‡§Æ‡§ß‡•Ä‡§≤ ‡§∂‡§¨‡•ç‡§¶ (G, L, v, x)
        const shreelipi_list = ['‚Ä¶','b','√ø','√Ñ','@','Q¬¥','u','¬™','}','[','p','H','¬≥','I','¬ª','J','¬Ω','K','M','√Ä','N','¬µO','O','¬µ√Å','√Å','P','Q','R','¬∂S','S','¬∂T','T','U','√ä','W','√è','V','√ã','Y','√ú','X','Z','√ù','‚Äô','√¢','n','√ü','^','√§','~','√£','‚Äò','√•','¬∂','a','c','√´','d','√¨','e','√ª','√≠','f','√Æ','g','√±','h','j','√∫','k','√î','√õ','√ö','√†','√û','Q¬≠','¬∫$','√å','√ê','√ï','l','√ém','¬∏','‚Äû','ÀÜ','≈ì','√Ö','Am¬°','Amo','Am|','Am','A','B¬©','B','C','D','Eo','E','F','m¬∞','mo','m|','o','|','m¬°','m¬¢','¬°','¬¢','m','r','s','t','w','√æ','y','¬ß','¬±','‚Ä¢','¬•','¬≤','√ë','¬´','√©','√™','&','$','>','¬µ', 
        // NEW ADDITIONS
        'G', 'L', 'v', 'x', '%', '=', '(', ')'];
        
        const unicode_list = ['‡§É',"‡§≤","‡•Ç","‡§û‡•ç",'‡§Ω','‡§ü‡•ç‡§∞','¬©','¬©‡§Ç','{¬©','{','{',"‡§ï",'‡§ï‡•ç',"‡§ñ",'‡§ñ‡•ç',"‡§ó",'‡§ó‡•ç',"‡§ò",'‡§ö','‡§ö‡•ç','‡§õ','‡§ú‡§º','‡§ú','‡§ú‡§º‡•ç','‡§ú‡•ç','‡§ù',"‡§ü","‡§†",'‡§°‡§º',"‡§°",'‡§¢‡§º','‡§¢',"‡§£",'‡§£‡•ç',"‡§•",'‡§•‡•ç',"‡§§",'‡§§‡•ç',"‡§ß",'‡§ß‡•ç',"‡§¶","‡§®",'‡§®‡•ç',"‡§´",'‡§´‡•ç',"‡§™",'‡§™‡•ç',"‡§≠",'‡§≠‡•ç',"‡§¨",'‡§¨‡•ç',"‡§Æ",'‡§Æ‡•ç',"‡§Ø","‡§∞","‡§≤",'‡§≤‡•ç',"‡§µ",'‡§µ‡•ç',"‡§∂",'‡§∂‡•ç','‡§∂‡•ç',"‡§∑",'‡§∑‡•ç',"‡§∏",'‡§∏‡•ç',"‡§π",'‡§ï‡•ç‡§∑','‡§ï‡•ç‡§∑‡•ç','‡§ú‡•ç‡§û','‡§¶‡•ç‡§¶','‡§¶‡•ç‡§µ','‡§¶‡•ç‡§Ø','‡§™‡•ç‡§∞','‡§®‡•ç‡§®','‡§ü‡•ç‡§∞','‡§ï‡•ç‡§§','‡§§‡•ç‡§∞','‡§¶‡•ç‡§∞','‡§¶‡•ç‡§ß','‡§∂‡•ç‡§∞','‡§§‡•ç‡§§','‡§ï‡•ç‡§ï','‡§≤‡•ç‡§≤','‡§π‡•ç‡§µ','‡§∂‡•ç‡§µ','‡§ü‡•ç‡§ü','‡§î','‡§ì','‡§ì‡§Ç','‡§Ü','‡§Ö','‡§à','‡§á','‡§â','‡§ä','‡§ê','‡§è','‡§ã','‡•â',"‡•ã","‡•ã‡§Ç","‡•á","‡•á‡§Ç","‡•å","‡•å‡§Ç","‡•à",'‡•à‡§Ç',"‡§æ","‡•Ä","‡•Ä","‡•Ä‡§Ç","‡•Å",'‡•Å',"‡•Ç",'‡§Ç','‡§Å','‡§É','‡•É','‡•ç','‡§¶‡•É','‡•ç‡§∞','‡§∞‡•Å','‡§∞‡•Ç','‡•§','‡•§','','', 
        // NEW MAPPINGS
        '‡§ú', '‡§°', '‡•à', '‡•Ö', '‡•Ñ', '.', '(', ')'];

        // --- 2. RESTORED STABLE LOGIC (From V4) ---
        function convertText(inputText) {
            if (!inputText) return "";
            
            let res = inputText; 

            // A. Basic Mapping Replacement
            for (let i = 0; i < shreelipi_list.length; i++) {
                if (shreelipi_list[i] && unicode_list[i]) {
                    res = res.split(shreelipi_list[i]).join(unicode_list[i]);
                }
            }

            // B. FIX: '{' Matra ({‡§µ‡§ö‡§æ‡§∞ -> ‡§µ‡§ø‡§ö‡§æ‡§∞)
            // Using the safe 'while' loop from V4
            let pos_curly = res.indexOf("{");
            while (pos_curly !== -1) {
                if (pos_curly + 1 < res.length) {
                    let next_char = res.charAt(pos_curly + 1);
                    if (next_char !== ' ' && next_char !== '¬©') { 
                        let target = "{" + next_char;
                        res = res.replace(target, next_char + "‡§ø");
                    }
                }
                pos_curly = res.indexOf("{", pos_curly + 1);
            }

            // C. FIX: 'o' Matra
            let pos_o = res.indexOf("o");
            while (pos_o !== -1) {
                if (pos_o + 1 < res.length) {
                    let next_char = res.charAt(pos_o + 1);
                    if (next_char !== ' ' && next_char !== '‡•ç') {
                        let target = "o" + next_char;
                        res = res.replace(target, next_char + "‡§ø");
                    }
                }
                pos_o = res.indexOf("o", pos_o + 1);
            }

            // D. FIX: Half Letter Velaanti
            let pos_half = res.indexOf("‡§ø‡•ç");
            while (pos_half !== -1) {
                if (pos_half + 2 < res.length) {
                    let cons = res.charAt(pos_half + 2);
                    res = res.replace("‡§ø‡•ç" + cons, "‡•ç" + cons + "‡§ø");
                }
                pos_half = res.indexOf("‡§ø‡•ç", pos_half + 2);
            }

            // E. FIX: 'q' -> 'o'
            let pos_q = res.indexOf("q");
            while (pos_q !== -1) {
                 if (pos_q + 1 < res.length) {
                    let next = res.charAt(pos_q + 1);
                    res = res.replace("q" + next, next + "o");
                 }
                 pos_q = res.indexOf("q", pos_q + 1);
            }

            // F. FIX: 'o' + Halant
            let pos_oh = res.indexOf("o‡•ç");
            while (pos_oh !== -1) {
                if (pos_oh + 2 < res.length) {
                    let cons = res.charAt(pos_oh + 2);
                    res = res.replace("o‡•ç" + cons, "‡•ç" + cons + "‡§ø‡§Ç");
                }
                pos_oh = res.indexOf("o‡•ç", pos_oh + 3);
            }

            // Cleanup
            res = res.replace(/o/g, "‡§ø‡§Ç");

            // G. Reph (Rafar) ¬© -> ‡§∞‡•ç
            const matras = "‡§æ‡§ø‡•Ä‡•Å‡•Ç‡•É‡•á‡•à‡•ã‡•å‡§Ç‡§É‡§Å‡•Ö";
            let pos_reph = res.indexOf("¬©");
            while (pos_reph > 0) {
                let prob = pos_reph - 1;
                while (prob >= 0 && matras.includes(res.charAt(prob))) {
                    prob--;
                }
                if (prob < 0) prob = 0;
                
                let chunk = res.substring(prob, pos_reph);
                res = res.substring(0, prob) + "‡§∞‡•ç" + chunk + res.substring(pos_reph + 1);
                pos_reph = res.indexOf("¬©", prob + chunk.length + 2);
            }

            return res;
        }

        // --- 3. REPORT LOGIC (From V5) ---
        function analyzeUnconverted(text) {
            const words = text.split(/\s+/);
            const unconvertedSet = new Set();
            const hasDevanagari = /[\u0900-\u097F]/;
            const hasASCII = /[a-zA-Z\u0080-\u00FF]/;

            words.forEach(word => {
                let clean = word.replace(/^[.,()'"-]+|[.,()'"-]+$/g, "");
                if (clean.length > 0 && !hasDevanagari.test(clean) && hasASCII.test(clean)) {
                    unconvertedSet.add(clean);
                }
            });
            return Array.from(unconvertedSet);
        }

        // --- 4. UI HANDLERS ---
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const fileNameDiv = document.getElementById('fileName');
        const statusDiv = document.getElementById('status');
        const reportBox = document.getElementById('reportBox');
        const wordListDiv = document.getElementById('wordList');

        fileInput.addEventListener('change', () => {
            if(fileInput.files.length > 0) {
                fileNameDiv.innerText = "Selected: " + fileInput.files[0].name;
                convertBtn.disabled = false;
                reportBox.style.display = "none";
            }
        });

        convertBtn.addEventListener('click', async () => {
            convertBtn.disabled = true;
            convertBtn.innerText = "Processing...";
            let fullText = "";

            try {
                if (typeof JSZip === 'undefined') throw new Error("Check Internet Connection.");
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                
                if (!zip.file("word/document.xml")) throw new Error("Invalid Docx.");
                const docXml = await zip.file("word/document.xml").async("string");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, "text/xml");
                const textNodes = xmlDoc.getElementsByTagName("w:t");

                for (let i = 0; i < textNodes.length; i++) {
                    let original = textNodes[i].textContent;
                    if (original && original.trim().length > 0) {
                        let converted = convertText(original);
                        textNodes[i].textContent = converted;
                        fullText += " " + converted;
                    }
                }

                // Show Report
                const missing = analyzeUnconverted(fullText);
                if (missing.length > 0) {
                    reportBox.style.display = "block";
                    wordListDiv.innerText = missing.join(", ");
                    statusDiv.innerText = "Done! Review the list below.";
                    statusDiv.style.color = "orange";
                } else {
                    statusDiv.innerText = "Success! 100% Converted.";
                    statusDiv.style.color = "green";
                }

                const serializer = new XMLSerializer();
                const newDocXml = serializer.serializeToString(xmlDoc);
                zip.file("word/document.xml", newDocXml);
                const blob = await zip.generateAsync({type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "Converted_" + file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                convertBtn.innerText = "Done!";
                setTimeout(() => convertBtn.disabled = false, 2000);

            } catch (err) {
                alert("Error: " + err.message);
                convertBtn.innerText = "Try Again";
                convertBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
